!
! Copyright (C) 2001-2021 Quantum ESPRESSO group
! This file is distributed under the terms of the
! GNU General Public License. See the file `License'
! in the root directory of the present distribution,
! or http://www.gnu.org/copyleft/gpl.txt .
!

! XML routines non relying on qexsd. For a small code such as
! GIPAW, qexsd is an overkill. Here I use the FoX library directly
! to input and output XML files

! commodity macros
#define CHECK_IONODE if (.not. ionode) return

! XML output
#define NE(x) call XML_NewElement(xmlf, #x)
#define ADDS(x) call XML_AddCharacters(xmlf, trim((x)))
#define ADDV(x) call XML_AddCharacters(xmlf, (x))
#define EE(x) call XML_EndElement(xmlf, #x)
#define OUTS(x) call XML_NewElement(xmlf, #x); call XML_AddCharacters(xmlf, trim((x))); call XML_EndElement(xmlf, #x);
#define OUTV(x) call XML_NewElement(xmlf, #x); call XML_AddCharacters(xmlf, (x)); call XML_EndElement(xmlf, #x);
#define ATTR(x,y) call XML_AddAttribute(xmlf, #x, (y))

!-----------------------------------------------------------------------
MODULE xml_gipaw_module
!-----------------------------------------------------------------------  
  ! ... This module contains the variables routines to I/O the XML files
  USE kinds,                       ONLY : dp
  USE io_global,                   ONLY : ionode
  USE fox_wxml                     ! to output XML
  USE fox_dom                      ! to parse XML file

  IMPLICIT NONE
  SAVE
  
  type(xmlf_t) :: xmlf             ! xml file handle

  character(5),  parameter :: fmt_name = "QEXSD"
  character(8),  parameter :: fmt_version = "21.07.16"

  PUBLIC :: open_xml_output, close_xml_output
  PUBLIC :: xml_output_generalinfo, xml_output_parallelinfo
  PUBLIC :: xml_output_namelist
  !PUBLIC :: xml_output_nmr, xml_output_gtensor, xml_output_efg, xml_output_hfi
  !PUBLIC :: xml_output_status
  !PUBLIC :: xml_output_timinginfo
  !PUBLIC :: xml_output_closed

  CONTAINS


  !-----------------------------------------------------------------------
  SUBROUTINE open_xml_output(filename)
  !-----------------------------------------------------------------------
    implicit none
    character(len=*), intent(in) :: filename
    integer :: ierr

    CHECK_IONODE
    call XML_OpenFile(filename, xmlf, replace=.true., pretty_print=.true., namespace=.true., iostat=ierr)
    !if ierr

    ! write namespace
    call XML_DeclareNamespace(xmlf, prefix="xsi", nsURI="http://www.w3.org/2001/XMLSchema-instance")
    call XML_DeclareNamespace(xmlf, prefix="qes", nsURI="http://www.quantum-espresso.org/ns/qes/qes-1.0")
    call XML_NewElement(xmlf, name="qes:espresso")
    call XML_AddAttribute(xmlf, name="xsi:schemaLocation", &
                          value="http://www.quantum-espresso.org/ns/qes/qes-1.0 "//&
                                "http://www.quantum-espresso.org/ns/qes/qes_210716.xsd")   ! cambiare questo!!!
  END SUBROUTINE open_xml_output


  !-----------------------------------------------------------------------
  SUBROUTINE close_xml_output
  !-----------------------------------------------------------------------
    implicit none
   
    CHECK_IONODE
    call XML_Close(xmlf, empty=.false.)

  END SUBROUTINE close_xml_output


  !-----------------------------------------------------------------------
  SUBROUTINE xml_output_generalinfo
  !-----------------------------------------------------------------------
    USE gipaw_version
    implicit none
    character(9) :: cdate, ctime
    character(60) :: timestamp

    call date_and_tim(cdate, ctime)
    timestamp = 'This run was terminated on:  ' // ctime // ' ' // cdate(1:2) // ' '//cdate(3:5) // ' '// cdate (6:9)

    CHECK_IONODE
    NE(general_info)
      NE(xml_format)
        ATTR(name, fmt_name)
        ATTR(version, fmt_version)
        ADDV(fmt_name//'_'//fmt_version)
      EE(xml_format)
      NE(creator)
        ATTR(name, 'GIPAW')
        ATTR(version, gipaw_git_revision)
        ADDV('XML file generated by GIPAW')
      EE(creator)
      NE(created)
        ATTR(date, cdate)
        ATTR(time, ctime)
        ADDS(timestamp)
      EE(created)
    EE(general_info)

  END SUBROUTINE xml_output_generalinfo


  !-----------------------------------------------------------------------
  SUBROUTINE xml_output_parallelinfo
  !-----------------------------------------------------------------------
    USE mp_world,         ONLY : nproc
    USE mp_pools,         ONLY : npool
    USE mp_bands,         ONLY : ntask_groups, nproc_bgrp, nbgrp
    implicit none
    integer :: nthreads=1
#if defined(__OMP) 
    integer, external :: omp_get_max
    nthreads = omp_get_max()
#endif      

    CHECK_IONODE
    NE(parallel_info)
      OUTV(nproc)
      OUTV(nthreads)
      OUTV(ntask_groups)
      OUTV(nbgrp)
      OUTV(npool)
      OUTV(nproc_bgrp)
    EE(parallel_info)

  END SUBROUTINE xml_output_parallelinfo


  !-----------------------------------------------------------------------
  SUBROUTINE xml_output_namelist
  !-----------------------------------------------------------------------
    USE io_files,        ONLY : prefix, tmp_dir
    USE uspp_data,       ONLY : spline_ps
    USE gipaw_module     ! to access internal variables
    implicit none

    CHECK_IONODE
    NE(input)
      OUTS(job)
      OUTS(prefix)
      OUTS(tmp_dir)
      OUTV(conv_threshold)
      OUTS(restart_mode)
      OUTV(q_gipaw)
      OUTS(verbosity)
      OUTS(filcurr)
      OUTS(filfield)
      OUTS(filnics)
      OUTV(pawproj)
      OUTV(use_nmr_macroscopic_shape)
      OUTV(nmr_macroscopic_shape)
      OUTV(spline_ps)
      OUTS(diagonalization)
      OUTV(q_efg)
      OUTV(max_seconds)
      OUTV(r_rand)
      OUTS(hfi_output_unit)
      OUTV(hfi_nuclear_g_factor)
      OUTV(core_relax_method)
      OUTV(hfi_via_reconstruction_only)
    EE(input)
  END SUBROUTINE xml_output_namelist


END MODULE xml_gipaw_module

